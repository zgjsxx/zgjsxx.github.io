import{_ as n,V as s,W as a,a0 as e}from"./framework-9a29aaa0.js";const t={},p=e(`<h1 id="深入理解glibc-barrier的实现原理" tabindex="-1"><a class="header-anchor" href="#深入理解glibc-barrier的实现原理" aria-hidden="true">#</a> 深入理解glibc barrier的实现原理</h1><p>在多线程的同步方式中，屏障可以协调多个线程，使其同时停止在某一个点，然后再统一运行。</p><p><code>pthread_barrier_wait</code>实现了该功能。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
    <span class="token keyword">int</span> <span class="token function">pthread_barrier_wait</span><span class="token punctuation">(</span><span class="token class-name">pthread_barrier_t</span> <span class="token operator">*</span>barrier<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>本文将从<code>pthread_barrier_wait</code>出发，讲解其背后的实现原理。</p><h2 id="pthread-barrier-t的结构" tabindex="-1"><a class="header-anchor" href="#pthread-barrier-t的结构" aria-hidden="true">#</a> pthread_barrier_t的结构</h2><p><code>pthread_barrier_t</code>的结构定义在<code>sysdeps/nptl/bits/pthreadtypes.h</code>中，是一个联合体。联合体中有两个字段，第一个字段是char类型的数组。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">union</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> __size<span class="token punctuation">[</span>__SIZEOF_PTHREAD_BARRIER_T<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> <span class="token keyword">int</span> __align<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">pthread_barrier_t</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个char数组各bit的定义在另一个结构体<strong>pthread_barrier</strong>中，定义在<code>sysdeps/nptl/internaltypes.h</code>。</p><p>这个才是barrier的真实定义，其有用5个字段。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pthread_barrier</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> in<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_round<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
  <span class="token keyword">int</span> shared<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个字段的含义如下所示：</p><ul><li><p>in：已经抵达barrier的线程数量。</p></li><li><p>current_round:当前这轮的基数。由于barrier是可以重复使用的，例如一个屏障可以允许2个线程通过，当这个2个线程达到该屏障之后，该屏障可以继续工作，重复使用。</p></li><li><p>count：每一轮需要抵达barrier的线程数量。</p></li><li><p>shared: 是否在多进程间使用。</p></li><li><p>out: 出屏障的线程总和。</p></li></ul><p><strong>current_round</strong>是比较难理解的字段，需要注意的是屏障是可以多次使用的，一批线程抵达屏障再一起出屏障之后，下一批线程又可以抵达屏障再一起出屏障。 <strong>current_round</strong>和这个相关，下面在源码解读中对其进行深入解读。</p><h2 id="pthread-barrier-wait源码分析" tabindex="-1"><a class="header-anchor" href="#pthread-barrier-wait源码分析" aria-hidden="true">#</a> pthread_barrier_wait源码分析</h2><p>首先,<code>pthread_barrier_wait</code>函数将进入屏障的线程数字段(bar-&gt;in)加1，变量i存储的就是加1后的值。注意这里使用的是acq_rel的内存序，因为下面将要根据i进行if-else判断，这里不能乱序。</p><p>除此以外，count值也读取了进来。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>  <span class="token keyword">struct</span> <span class="token class-name">pthread_barrier</span> <span class="token operator">*</span>bar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pthread_barrier</span> <span class="token operator">*</span><span class="token punctuation">)</span> barrier<span class="token punctuation">;</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>

 reset_restart<span class="token operator">:</span>

  i <span class="token operator">=</span> <span class="token function">atomic_fetch_add_acq_rel</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count <span class="token operator">=</span> bar<span class="token operator">-&gt;</span>count<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面这一段是用于处理IN值超过最大限制的场景。因为barrier是可以重复使用的，比如设置count为2，则可以第一轮限制2个线程通过， 第二轮还可以限制2个线程通过，依此类推。这个过程中，<code>bar-&gt;in</code>字段是不断递增的，因此可能存在溢出的场景。如果溢出了话，调用<code>futex_wait</code>进行等待，因为其他线程会有reset的操作，在<code>pthread_barrier_wait</code>的最后。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>     <span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_in_before_reset <span class="token operator">=</span> BARRIER_IN_THRESHOLD
				   <span class="token operator">-</span> BARRIER_IN_THRESHOLD <span class="token operator">%</span> count<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> max_in_before_reset<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> max_in_before_reset<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">futex_wait_simple</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">,</span> i<span class="token punctuation">,</span> bar<span class="token operator">-&gt;</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
            i <span class="token operator">=</span> <span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> reset_restart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，读取当前这一轮的基础，如果<code>i &gt; cr + count</code>，意味着已经有足够多的线程抵达了barrier，该线程不用wait，且需要将之前的waiter唤醒。注意futex_wake的第二参数是INT_MAX，代表会将所有的waiter都唤醒。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>    <span class="token keyword">unsigned</span> cr <span class="token operator">=</span> <span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cr <span class="token operator">+</span> count <span class="token operator">&lt;=</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> newcr <span class="token operator">=</span> i <span class="token operator">-</span> i <span class="token operator">%</span> count<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_compare_exchange_weak_release</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cr<span class="token punctuation">,</span>
						newcr<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            cr <span class="token operator">=</span> newcr<span class="token punctuation">;</span>
            <span class="token function">futex_wake</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> bar<span class="token operator">-&gt;</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> cr<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> ready_to_leave<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与上面的code对应，这段就代表还没有足够的线程进入barrier，因此调用futex_wait进行等待。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> cr<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">futex_wait_simple</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">,</span> cr<span class="token punctuation">,</span> bar<span class="token operator">-&gt;</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr <span class="token operator">=</span> <span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>程序的最后，要处理以下之前提到的&quot;溢出&quot;问题。当out值达到了阈值，则将current_round，out和in都置0。相当于reset操作，reset之后，barrier就和刚刚调用pthread_barrier_init时的状态相同了。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>    o <span class="token operator">=</span> <span class="token function">atomic_fetch_add_release</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>out<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> max_in_before_reset<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">atomic_thread_fence_acquire</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">atomic_store_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>current_round<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">atomic_store_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> shared <span class="token operator">=</span> bar<span class="token operator">-&gt;</span>shared<span class="token punctuation">;</span>
        <span class="token function">atomic_store_release</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">futex_wake</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gdb观察条件变量的内部值的变化" tabindex="-1"><a class="header-anchor" href="#gdb观察条件变量的内部值的变化" aria-hidden="true">#</a> gdb观察条件变量的内部值的变化</h2><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//g++ test.cpp -g</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token class-name">pthread_mutex_t</span> numlock<span class="token punctuation">;</span>
<span class="token class-name">pthread_barrier_t</span> b<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pthread_barrier</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> in<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_round<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
  <span class="token keyword">int</span> shared<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pthread_barrier <span class="token operator">*</span>b_real <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>numlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>numlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread enter wait point\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_barrier_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">pthread_t</span> t1<span class="token punctuation">,</span>t2<span class="token punctuation">;</span>
    <span class="token function">pthread_barrier_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化屏障</span>
    b_real <span class="token operator">=</span> <span class="token punctuation">(</span>pthread_barrier <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>numlock<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>handle<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>handle<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="准备阶段" tabindex="-1"><a class="header-anchor" href="#准备阶段" aria-hidden="true">#</a> 准备阶段</h3><p>在调试该程序之前，为了更好的观察运行的过程，可以安装glibc的debuginfo。</p><p>本人的虚拟环境如下所示：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost test4<span class="token punctuation">]</span><span class="token comment"># cat /etc/redhat-release</span>
Rocky Linux release <span class="token number">9.2</span> <span class="token punctuation">(</span>Blue Onyx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>其debuginfo可以在下面的地址中下载<code>https://dl.rockylinux.org/stg/rocky/9.2/devel/x86_64/debug/tree/Packages/g/</code>。找到下面这两项，将其下载到虚拟环境中，使用<code>yum install</code>安装。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>glibc-debuginfo-2.34-60.el9.x86_64.rpm
glibc-debugsource-2.34-60.el9.x86_64.rpm  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>有了debuginfo后，就可以进入到glibc的源码中进行调试。</p><h3 id="跟踪运行-第一轮" tabindex="-1"><a class="header-anchor" href="#跟踪运行-第一轮" aria-hidden="true">#</a> 跟踪运行-第一轮</h3><p>在pthread_barrier_wait方法上下一个断点，在代码中是31行，运行代码。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost test4<span class="token punctuation">]</span><span class="token comment"># gdb a.out -q</span>
Reading symbols from a.out<span class="token punctuation">..</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b test.cpp:31
Breakpoint <span class="token number">1</span> at 0x401223: <span class="token function">file</span> test.cpp, line <span class="token number">31</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> r
Starting program: /home/work/cpp_proj/test4/a.out
<span class="token punctuation">[</span>Thread debugging using libthread_db enabled<span class="token punctuation">]</span>
Using <span class="token function">host</span> libthread_db library <span class="token string">&quot;/lib64/libthread_db.so.1&quot;</span><span class="token builtin class-name">.</span>
<span class="token punctuation">[</span>New Thread 0x7ffff77ff640 <span class="token punctuation">(</span>LWP <span class="token number">72128</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>New Thread 0x7ffff6ffe640 <span class="token punctuation">(</span>LWP <span class="token number">72129</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">in</span> <span class="token operator">=</span> <span class="token number">0</span>
thread enter <span class="token function">wait</span> point
<span class="token keyword">in</span> <span class="token operator">=</span> <span class="token number">0</span>
thread enter <span class="token function">wait</span> point
<span class="token punctuation">[</span>Switching to Thread 0x7ffff77ff640 <span class="token punctuation">(</span>LWP <span class="token number">72128</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

Thread <span class="token number">2</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">1</span>, handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
<span class="token number">31</span>              pthread_barrier_wait<span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
Missing separate debuginfos, use: dnf debuginfo-install libgcc-11.3.1-4.3.el9.x86_64 libstdc++-11.3.1-4.3.el9.x86_64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从运行的结果看,目前线程2执行到了<code>pthread_barrier_wait(&amp;b)</code>这一句。</p><p>这个时候再pthread_barrier_wait.c的111行下一个断点,其内容就是对in变量+1的。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>i <span class="token operator">=</span> <span class="token function">atomic_fetch_add_acq_rel</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>in<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在这里下断点的目的就是更好的跟踪<code>pthread_barrier</code>的内部值的变化。同时为了避免多线程同时运行造成的影响，我们暂时关闭多线程同时运行。使用<code>set scheduler-locking on</code>可以实现这一点。</p><p>经过这个操作之后，使用next，单步调试，发现程序运行到了<code> i = atomic_fetch_add_acq_rel (&amp;bar-&gt;in, 1) + 1;</code>这一句。再使用next进行单步，这个时候打印bar变量的值。发现其in的值改成了1。这符合我们的预期，因为每有一个线程进入屏障，in值都应该+1。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b pthread_barrier_wait.c:111
Breakpoint <span class="token number">2</span> at 0x7ffff789da90: <span class="token function">file</span> pthread_barrier_wait.c, line <span class="token number">111</span>.
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> info thread
  Id   Target Id                                 Frame
  <span class="token number">1</span>    Thread 0x7ffff7ec4180 <span class="token punctuation">(</span>LWP <span class="token number">72124</span><span class="token punctuation">)</span> <span class="token string">&quot;a.out&quot;</span> __futex_abstimed_wait_common64 <span class="token punctuation">(</span>private<span class="token operator">=</span><span class="token number">128</span>, <span class="token assign-left variable">cancel</span><span class="token operator">=</span>true, <span class="token assign-left variable">abstime</span><span class="token operator">=</span>0x0,
    <span class="token assign-left variable">op</span><span class="token operator">=</span><span class="token number">265</span>, <span class="token assign-left variable">expected</span><span class="token operator">=</span><span class="token number">72128</span>, <span class="token assign-left variable">futex_word</span><span class="token operator">=</span>0x7ffff77ff910<span class="token punctuation">)</span> at futex-internal.c:57
* <span class="token number">2</span>    Thread 0x7ffff77ff640 <span class="token punctuation">(</span>LWP <span class="token number">72128</span><span class="token punctuation">)</span> <span class="token string">&quot;a.out&quot;</span> handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
  <span class="token number">3</span>    Thread 0x7ffff6ffe640 <span class="token punctuation">(</span>LWP <span class="token number">72129</span><span class="token punctuation">)</span> <span class="token string">&quot;a.out&quot;</span> handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> scheduler-locking on
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n

Thread <span class="token number">2</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">2</span>, ___pthread_barrier_wait <span class="token punctuation">(</span>barrier<span class="token operator">=</span>0x404100 <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">)</span> at pthread_barrier_wait.c:111
<span class="token number">111</span>       i <span class="token operator">=</span> atomic_fetch_add_acq_rel <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar-<span class="token operator">&gt;</span>in, <span class="token number">1</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n
<span class="token number">117</span>       unsigned int max_in_before_reset <span class="token operator">=</span> BARRIER_IN_THRESHOLD
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p *bar
<span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>in <span class="token operator">=</span> <span class="token number">1</span>, current_round <span class="token operator">=</span> <span class="token number">0</span>, count <span class="token operator">=</span> <span class="token number">2</span>, shared <span class="token operator">=</span> <span class="token number">0</span>, out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，我们重新允许多线程同时运行，使用<code>set scheduler-locking off</code>可以做到这一点。使用continue继续运行，这里再次停在了<code>i = atomic_fetch_add_acq_rel (&amp;bar-&gt;in, 1) + 1;</code>这一句上，继续next，然后打印bar变量，可以发现，到目前为止in的值为2。也是符合预期的。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> scheduler-locking off
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing.
<span class="token punctuation">[</span>Switching to Thread 0x7ffff6ffe640 <span class="token punctuation">(</span>LWP <span class="token number">72129</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

Thread <span class="token number">3</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">1</span>, handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
<span class="token number">31</span>              pthread_barrier_wait<span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n

Thread <span class="token number">3</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">2</span>, ___pthread_barrier_wait <span class="token punctuation">(</span>barrier<span class="token operator">=</span>0x404100 <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">)</span> at pthread_barrier_wait.c:111
<span class="token number">111</span>       i <span class="token operator">=</span> atomic_fetch_add_acq_rel <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar-<span class="token operator">&gt;</span>in, <span class="token number">1</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n
<span class="token number">117</span>       unsigned int max_in_before_reset <span class="token operator">=</span> BARRIER_IN_THRESHOLD
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p *bar
<span class="token variable">$2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>in <span class="token operator">=</span> <span class="token number">2</span>, current_round <span class="token operator">=</span> <span class="token number">0</span>, count <span class="token operator">=</span> <span class="token number">2</span>, shared <span class="token operator">=</span> <span class="token number">0</span>, out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时<code>in = current_round + count</code>，因此满足出屏障条件，下面可以出屏障继续执行。</p><h3 id="跟踪调试-第二轮" tabindex="-1"><a class="header-anchor" href="#跟踪调试-第二轮" aria-hidden="true">#</a> 跟踪调试-第二轮</h3><p>使用continue，两个线程便进入了第二轮进入屏障的过程。</p><p>这里重新设置只运行单线程运行。线程3停在了<code>i = atomic_fetch_add_acq_rel (&amp;bar-&gt;in, 1) + 1;</code>上。打印bar变量的值，可以看到此时in = 3，因为这是历史上第三个进入屏障的线程。</p><p>current_round代表在此轮之前，所有进入的线程总数，因此等于2。out代表所有出了屏障的线程总数，其值应该等于current_round，也等于2。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing.
<span class="token keyword">in</span> <span class="token operator">=</span> <span class="token number">2</span>
thread enter <span class="token function">wait</span> point
<span class="token keyword">in</span> <span class="token operator">=</span> <span class="token number">2</span>
thread enter <span class="token function">wait</span> point

Thread <span class="token number">3</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">1</span>, handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
<span class="token number">31</span>              pthread_barrier_wait<span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> scheduler-locking on
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n

Thread <span class="token number">3</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">2</span>, ___pthread_barrier_wait <span class="token punctuation">(</span>barrier<span class="token operator">=</span>0x404100 <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">)</span> at pthread_barrier_wait.c:111
<span class="token number">111</span>       i <span class="token operator">=</span> atomic_fetch_add_acq_rel <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar-<span class="token operator">&gt;</span>in, <span class="token number">1</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n
<span class="token number">117</span>       unsigned int max_in_before_reset <span class="token operator">=</span> BARRIER_IN_THRESHOLD
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p *bar
<span class="token variable">$3</span> <span class="token operator">=</span> <span class="token punctuation">{</span>in <span class="token operator">=</span> <span class="token number">3</span>, current_round <span class="token operator">=</span> <span class="token number">2</span>, count <span class="token operator">=</span> <span class="token number">2</span>, shared <span class="token operator">=</span> <span class="token number">0</span>, out <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，关闭多线程锁定，使用continue继续执行。此时线程2停在了<code>i = atomic_fetch_add_acq_rel (&amp;bar-&gt;in, 1) + 1;</code>上。打印bar的值发现in = 4。</p><p>此时<code>in = current_round + count</code>，因此满足出屏障条件，下面可以出屏障继续执行。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> scheduler-locking off
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing.
<span class="token punctuation">[</span>Switching to Thread 0x7ffff77ff640 <span class="token punctuation">(</span>LWP <span class="token number">72128</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

Thread <span class="token number">2</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">1</span>, handle <span class="token punctuation">(</span>data<span class="token operator">=</span>0x0<span class="token punctuation">)</span> at test.cpp:31
<span class="token number">31</span>              pthread_barrier_wait<span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n

Thread <span class="token number">2</span> <span class="token string">&quot;a.out&quot;</span> hit Breakpoint <span class="token number">2</span>, ___pthread_barrier_wait <span class="token punctuation">(</span>barrier<span class="token operator">=</span>0x404100 <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">)</span> at pthread_barrier_wait.c:111
<span class="token number">111</span>       i <span class="token operator">=</span> atomic_fetch_add_acq_rel <span class="token punctuation">(</span><span class="token operator">&amp;</span>bar-<span class="token operator">&gt;</span>in, <span class="token number">1</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> n
<span class="token number">117</span>       unsigned int max_in_before_reset <span class="token operator">=</span> BARRIER_IN_THRESHOLD
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> p *bar
<span class="token variable">$4</span> <span class="token operator">=</span> <span class="token punctuation">{</span>in <span class="token operator">=</span> <span class="token number">4</span>, current_round <span class="token operator">=</span> <span class="token number">2</span>, count <span class="token operator">=</span> <span class="token number">2</span>, shared <span class="token operator">=</span> <span class="token number">0</span>, out <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>在源码面前，所有的问题都是非常清晰的。本文通过分析<code>pthread_barrier_wait.c</code>的源码，了解了屏障可以使得一批线程同时等待在一个点，并同时运行的原理。 屏障是可以被重复使用的，使用了<code>in</code>,<code>current_round</code>,<code>count</code>三个变量实现了这个点。</p><p>在案例分析中，安装了glibc的debuginfo，跟踪了其中的内部变量的值的变化，验证了之前源码的分析。</p>`,58),o=[p];function c(i,l){return s(),a("div",null,o)}const u=n(t,[["render",c],["__file","linux-glibc-barrier.html.vue"]]);export{u as default};

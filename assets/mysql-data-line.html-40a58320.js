import{_ as n,V as s,W as a,a0 as e}from"./framework-9a29aaa0.js";const p={},t=e(`<h1 id="mysql中的行格式之compact格式分析" tabindex="-1"><a class="header-anchor" href="#mysql中的行格式之compact格式分析" aria-hidden="true">#</a> mysql中的行格式之compact格式分析</h1><h2 id="mysql行格式" tabindex="-1"><a class="header-anchor" href="#mysql行格式" aria-hidden="true">#</a> mysql行格式</h2><p>所谓行格式，就是指mysql一行数据的存储格式。</p><p>InnoDB 储存引擎支持有四种行储存格式：Compact、Redundant、Dynamic 和 Compressed。</p><p>Redundant是很古老的行格式了，因为占用空间最多，导致内存碎片化最严重，比较低效，现在基本上已经不用了，</p><p>Compact是MySQL 5.0之后引入的行记录存储方式，是一种紧凑的行格式，设计的初衷就是为了让一个数据页中可以存放更多的行记录，从 MySQL 5.1 版本之后，行格式默认设置成 Compact。</p><p>Dynamic和Compressed 两个都是紧凑的行格式，它们的行格式都和 Compact 差不多，因为都是基于 Compact进行改进。从 MySQL5.7 版本之后，默认使用 Dynamic 行格式。</p><p>应该说Compact格式是一个比较经典的格式，因此本文将以Compact格式为例，详细介绍其具体的内容。</p><h2 id="mysql表的数据存储在哪里" tabindex="-1"><a class="header-anchor" href="#mysql表的数据存储在哪里" aria-hidden="true">#</a> mysql表的数据存储在哪里？</h2><p>进入mysql，查看mysql的data目录在哪里，例如下面所示：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show variables like <span class="token string">&quot;datadir&quot;</span><span class="token punctuation">;</span>
+---------------+-----------------+
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> Value           <span class="token operator">|</span>
+---------------+-----------------+
<span class="token operator">|</span> datadir       <span class="token operator">|</span> /var/lib/mysql/ <span class="token operator">|</span>
+---------------+-----------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入该目录中，会看到一个以database命名的目录，进入该目录中，则会看到一个以表名+.ibd的文件，该文件即是存储mysql表数据的文件。</p><h2 id="compact-行格式长什么样" tabindex="-1"><a class="header-anchor" href="#compact-行格式长什么样" aria-hidden="true">#</a> COMPACT 行格式长什么样？</h2><p>compact行格式如下所示：</p><figure><img src="https://raw.githubusercontent.com/zgjsxx/static-img-repo/main/blog/database/mysql/row-format/compact-line.png" alt="mysql" tabindex="0" loading="lazy"><figcaption>mysql</figcaption></figure><p>主要分为两个个部分</p><ul><li>存储的额外数据</li><li>存储的真实数据</li></ul><p>存储的额外数据中包含了<strong>变长数据列的长度</strong>，<strong>NULL值的列表</strong>，<strong>记录头信息</strong>。</p><p>存储的真实数据中包含了<strong>三个隐藏列</strong>和<strong>真实数据</strong>。</p><p>首先看存储的额外数据。</p><p>存储的额外数据的第一块用于<strong>记录变长数据列的长度</strong>，其排放顺序是<strong>逆序排放</strong>的。</p><p>例如下面这张表，name和city列为变长字段，由于是逆序排放的，第一条记录的变长数据列的长度的值为<code>07 03</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>+------+-------+---------+-------+
<span class="token operator">|</span> <span class="token function">id</span>   <span class="token operator">|</span> name  <span class="token operator">|</span> city    <span class="token operator">|</span> level <span class="token operator">|</span>
+------+-------+---------+-------+
<span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> tom   <span class="token operator">|</span> Nanjing <span class="token operator">|</span> a     <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> kitty <span class="token operator">|</span> Beijing <span class="token operator">|</span> b     <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> simth <span class="token operator">|</span> Wuhan   <span class="token operator">|</span> c     <span class="token operator">|</span>
+------+-------+---------+-------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>额外数据的第二块是<strong>记录NULL值的列表</strong>，它使用bit来标记列值是否为空。其低位（最右侧的位）标记第0个列是否为NULL。</p><p>例如这里的第一条记录，其city列为NULL，因此其NULL列的值为<code>00000100</code>，为04。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>+------+-------+---------+-------+
<span class="token operator">|</span> <span class="token function">id</span>   <span class="token operator">|</span> name  <span class="token operator">|</span> city    <span class="token operator">|</span> level <span class="token operator">|</span>
+------+-------+---------+-------+
<span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> Nancy <span class="token operator">|</span> NULL    <span class="token operator">|</span> c     <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> NULL  <span class="token operator">|</span> NULL    <span class="token operator">|</span> c     <span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>额外数据的第三块是<strong>记录头信息</strong>，其格式如下所示，共5个字节：</p><table><thead><tr><th>名称</th><th>大小 (bit)</th><th>描述</th></tr></thead><tbody><tr><td>预留位1</td><td>1</td><td>没有使用</td></tr><tr><td>预留位2</td><td>1</td><td>没有使用</td></tr><tr><td>delete_mask</td><td>1</td><td>标记该记录是否被删除</td></tr><tr><td>min_rec_mask</td><td>1</td><td>B+树里每一层的非叶子节点里的最小值都有这个标记</td></tr><tr><td>n_owned</td><td>4</td><td>表示当前记录拥有的记录数</td></tr><tr><td>heap_no</td><td>13</td><td>表示当前记录在记录堆的位置信息</td></tr><tr><td>record_type</td><td>3</td><td>标识当前记录的类型：0代表的是普通类型，1代表的是B+树非叶子节点，2代表的是最小值数据，3代表的是最大值数据。</td></tr><tr><td>next_record</td><td>16</td><td>表示下一条记录的相对位置</td></tr></tbody></table><p>接下来是存储的真实数据部分：</p><p>其第一部分包含三个隐藏列，其格式如下所示：</p><ul><li>DB_ROW_ID：该字段占6个字节，用于标识一条记录</li><li>DB_TRX_ID：该字段占6个字节，其值为事务ID</li><li>DB_ROLL_PTR：该字段占7个字节，其值为回滚指针</li></ul><p>其第二部分存储的就是每个非NULL列真实的数据。</p><p>有了这些基础，下面对照ibd文件，具体分析。</p><h2 id="实验分析ibd文件格式" tabindex="-1"><a class="header-anchor" href="#实验分析ibd文件格式" aria-hidden="true">#</a> 实验分析ibd文件格式</h2><p>下面将通过分析<code>.ibd</code>文件的方式来进一步了解。首先需要准备好环境。这里我使用的是docker环境进行环境准备的。</p><p>首先使用<code>docker pull</code>拉取最新版本的mysql的镜像。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> pull mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>再镜像拉取完毕之后启动mysql，这里我将本地目录挂载到了mysql容器中，便于后续获取ibd文件。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-v</span> /home/work/data/mysql:/var/lib/mysql/ <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">111111</span> <span class="token parameter variable">-d</span> 镜像的id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>进入mysql容器中，创建demo的数据库，并在demo数据库中创建user_tbl表。user_tbl表包含了四个字段，其中name和city字段为变长字段。id和level为固定长度字段。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> demo<span class="token punctuation">;</span>
<span class="token keyword">use</span> demo<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_tbl <span class="token punctuation">(</span>
	id <span class="token keyword">int</span><span class="token punctuation">,</span>
	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;mutable-length&#39;</span><span class="token punctuation">,</span>
	city <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;mutable-length&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">level</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">&#39;fix-length&#39;</span>
<span class="token punctuation">)</span>row_format<span class="token operator">=</span>compact<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进一步，向user_tbl表中添加5条测试数据。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> user_tbl <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&#39;tom&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;Nanjing&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> user_tbl <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;kitty&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;Beijing&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> user_tbl <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&#39;simth&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;Wuhan&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> user_tbl <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;Nancy&#39;</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> user_tbl <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>退出容器，去挂载的目录中去获取idb文件，例如，我的目录就是<code>/home/work/data/mysql/demo/user_tbl.ibd</code>。</p><p>通过二进制查看工具，例如<code>notepad--</code>可以很好的对其进行分析。通过记录中的字符串，可以很快地在二进制文件中定位到位置，例如在我的实验中，数据记录在文件中的位置如下所示：</p><figure><img src="https://raw.githubusercontent.com/zgjsxx/static-img-repo/main/blog/database/mysql/row-format/data.png" alt="mysql" tabindex="0" loading="lazy"><figcaption>mysql</figcaption></figure><p>有了这些数据，就可以对其进行分析了。</p><p>我这里获取到的五条的数据记录如下所示，对照上面讲解的Compact数据行格式，是一致的。</p><p>第一条数据格式：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token number">07</span> <span class="token number">03</span> <span class="token comment">//第三列长度为7 第二列长度为3</span>
<span class="token number">00</span> <span class="token comment">//NULL bit映射为空</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">10</span> <span class="token number">00</span> <span class="token number">2</span>B <span class="token comment">//header info</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">00</span> <span class="token comment">//DB_ROW_ID </span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">07</span> <span class="token number">19</span> <span class="token comment">//DB_TRX_ID</span>
<span class="token number">82</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">1</span>E <span class="token number">01</span> <span class="token number">10</span> <span class="token comment">//DB_ROLL_PTR </span>
<span class="token number">80</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token comment">//0</span>
<span class="token number">74</span> <span class="token number">6F</span> <span class="token number">6</span>D    <span class="token comment">//tom </span>
<span class="token number">4</span>E <span class="token number">61</span> <span class="token number">6</span>E <span class="token number">6</span>A <span class="token number">69</span> <span class="token number">6</span>E <span class="token number">67</span> <span class="token comment">//Nanjing </span>
<span class="token number">61</span> <span class="token comment">//a</span>
<span class="token number">01</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二条数据格式：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token number">07</span> <span class="token number">05</span> <span class="token comment">//第三列长度为7 第二列长度为5</span>
<span class="token number">00</span> <span class="token comment">//NULL bit映射为空</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">18</span> <span class="token number">00</span> <span class="token number">2</span>D <span class="token comment">//header info</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">01</span> <span class="token comment">//DB_ROW_ID </span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">07</span> <span class="token number">1</span>A <span class="token comment">//DB_TRX_ID</span>
<span class="token number">81</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">1</span>E <span class="token number">01</span> <span class="token number">10</span> <span class="token comment">//DB_ROLL_PTR </span>
<span class="token number">80</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token comment">//1</span>
<span class="token number">6</span>B <span class="token number">69</span> <span class="token number">74</span> <span class="token number">74</span> <span class="token number">79</span> <span class="token comment">//kitty</span>
<span class="token number">42</span> <span class="token number">65</span> <span class="token number">69</span> <span class="token number">6</span>A <span class="token number">69</span> <span class="token number">6</span>E <span class="token number">67</span> <span class="token comment">//Beijing</span>
<span class="token number">62</span> <span class="token comment">//b</span>
<span class="token number">01</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三条数据格式：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token number">05</span> <span class="token number">05</span> <span class="token comment">//第三列长度为5 第二列长度为5</span>
<span class="token number">00</span> <span class="token comment">//NULL bit映射为空</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">20</span> <span class="token number">00</span> <span class="token number">2</span>A <span class="token comment">//header info</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">02</span> <span class="token comment">//DB_ROW_ID </span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">07</span> <span class="token number">1F</span> <span class="token comment">//DB_TRX_ID</span>
<span class="token number">82</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">0</span>A <span class="token number">01</span> <span class="token number">10</span> <span class="token comment">//DB_ROLL_PTR </span>
<span class="token number">80</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token comment">//2</span>
<span class="token number">73</span> <span class="token number">69</span> <span class="token number">6</span>D <span class="token number">74</span> <span class="token number">68</span> <span class="token comment">//simth</span>
<span class="token number">57</span> <span class="token number">75</span> <span class="token number">68</span> <span class="token number">61</span> <span class="token number">6</span>E <span class="token comment">//Wuhan</span>
<span class="token number">63</span> <span class="token comment">//c</span>
<span class="token number">01</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四条数据格式：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token number">05</span> <span class="token comment">//第二列长度为5</span>
<span class="token number">04</span> <span class="token comment">//NULL 00000100 第三列为NULL</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">28</span> <span class="token number">00</span> <span class="token number">24</span> <span class="token comment">//header info</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">03</span> <span class="token comment">//DB_ROW_ID </span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">07</span> <span class="token number">20</span> <span class="token comment">//DB_TRX_ID</span>
<span class="token number">81</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">0</span>E <span class="token number">01</span> <span class="token number">10</span> <span class="token comment">//DB_ROLL_PTR </span>
<span class="token number">80</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">03</span> <span class="token comment">//3</span>
<span class="token number">4</span>E <span class="token number">61</span> <span class="token number">6</span>E <span class="token number">63</span> <span class="token number">79</span> <span class="token comment">//Nancy</span>
<span class="token number">63</span> <span class="token comment">//c</span>
<span class="token number">01</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第五条数据格式：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 没有变长列的长度</span>
<span class="token number">06</span> <span class="token comment">//NULL 00000110 第二列和第二列为NULL</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">30</span> FF <span class="token number">49</span> <span class="token comment">//header info</span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">02</span> <span class="token number">04</span> <span class="token comment">//DB_ROW_ID </span>
<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">07</span> <span class="token number">25</span> <span class="token comment">//DB_TRX_ID</span>
<span class="token number">82</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">01</span> <span class="token number">0</span>C <span class="token number">01</span> <span class="token number">10</span> <span class="token comment">//DB_ROLL_PTR </span>
<span class="token number">80</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">04</span> <span class="token comment">//4 </span>
<span class="token number">63</span> <span class="token comment">//c</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,58),o=[t];function l(c,r){return s(),a("div",null,o)}const m=n(p,[["render",l],["__file","mysql-data-line.html.vue"]]);export{m as default};

import{_ as n,V as s,W as e,a0 as a}from"./framework-9a29aaa0.js";const i={},t=a(`<h1 id="使用veth和bridge搭建docker网络" tabindex="-1"><a class="header-anchor" href="#使用veth和bridge搭建docker网络" aria-hidden="true">#</a> 使用veth和bridge搭建docker网络</h1><p>创建三个network namespace</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> netns <span class="token function">add</span> red
<span class="token function">ip</span> netns <span class="token function">add</span> blue
<span class="token function">ip</span> netns <span class="token function">add</span> green
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看namespace</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ip netns ls</span>
green
red
blue
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建bridge</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> vbridge <span class="token builtin class-name">type</span> bridge
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev vbridge up 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>创建3个veth pair</p><p>这里需要主义的是， Linux 内核对网络接口的名字长度有限制，不能超过15个字符。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> veth-red <span class="token builtin class-name">type</span> veth peer name veth-red-br
<span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> veth-blue <span class="token builtin class-name">type</span> veth peer name veth-blue-br
<span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> veth-green <span class="token builtin class-name">type</span> veth peer name veth-green-br
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将veth-red连接到namespace red, 另一端veth-red-br连接到vbridge 将veth-blue连接到namespace blue, 另一端veth-blue-br连接到vbridge 将veth-green连接到namespace green, 另一端veth-green-br连接到vbridge</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-red netns red
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-red-br master vbridge
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-blue netns blue
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-blue-br master vbridge
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-green netns green
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-green-br master vbridge
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>bridge link查看</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># bridge link</span>
<span class="token number">21</span>: veth-blue-br@if22: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> master vbridge state disabled priority <span class="token number">32</span> cost <span class="token number">2</span>
<span class="token number">23</span>: veth-red-br@if24: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> master vbridge state disabled priority <span class="token number">32</span> cost <span class="token number">2</span>
<span class="token number">25</span>: veth-green-br@if26: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> master vbridge state disabled priority <span class="token number">32</span> cost <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给veth-blue与veth-red添加ip地址：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> red <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.28.1/24 dev veth-red
<span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> blue <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.28.2/24 dev veth-blue
<span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> green <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">192.168</span>.28.3/24 dev veth-green
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> red <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-red up
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev veth-red-br up
<span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> blue <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-blue up
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev veth-blue-br up
<span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> green <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-green up
<span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev veth-green-br up
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用bridge的路由模式连通namespace与host 在上文中我们在主机里面创建了一个虚拟的私有网络192.168.15.0/24，里面具有2个网络空间blue和red，通过vbridge-0连接。这个网络对我们的主机来讲是无法连通，因为我们的主机与该网络不属于一个子网（本例中主机IP为：172.31.47.15，通过ip addr查看eth0网卡的ip地址）：</p><p>ip netns exec red ping 192.168.26.11</p><p>添加默认网关 ip addr add 192.168.28.5/24 dev vbridge</p><p>ip netns exec red ip route add default via 192.168.28.5</p><p>ip netns exec blue ip route add default via 192.168.28.5</p><p>ip netns exec green ip route add default via 192.168.28.5</p><p>ip netns exec red ping 192.168.26.11</p><p>联通外网</p><p>$ sysctl net.ipv4.ip_forward net.ipv4.ip_forward = 0</p><h1 id="开启ip-forward" tabindex="-1"><a class="header-anchor" href="#开启ip-forward" aria-hidden="true">#</a> 开启ip forward</h1><p>$ sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1</p><p>通过iptables增加SNAT规则，将源ip为192.168.15.0/24内的数据包的源ip修改为eth0的ip：</p><p>$ iptables -t nat -A POSTROUTING -s 192.168.28.0/24 -j MASQUERADE</p><p>外网联通容器</p><p>iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.28.1:80</p><p>本文从network namespace出发，使用veth pair，bridge，NAT等虚拟网络设备和技术在一个Linux主机中搭建了一个虚拟网络，并实现了如下效果：</p><p>虚拟网络的设备直接可以互相访问； 虚拟网络的设备与主机之间可以互相访问； 虚拟网络的设备可以访问公网。</p>`,34),p=[t];function l(c,d){return s(),e("div",null,p)}const r=n(i,[["render",l],["__file","docker-network.html.vue"]]);export{r as default};

import{_ as n,V as s,W as a,a0 as p}from"./framework-9a29aaa0.js";const t={},e=p(`<h1 id="linux-0-11-kernel目录fork-c详解" tabindex="-1"><a class="header-anchor" href="#linux-0-11-kernel目录fork-c详解" aria-hidden="true">#</a> Linux-0.11 kernel目录fork.c详解</h1><h2 id="模块简介" tabindex="-1"><a class="header-anchor" href="#模块简介" aria-hidden="true">#</a> 模块简介</h2><p>fork.c中主要实现内核对于创建新的进程的行为。其中<code>copy_process</code>是其最核心的函数。</p><h2 id="函数详解" tabindex="-1"><a class="header-anchor" href="#函数详解" aria-hidden="true">#</a> 函数详解</h2><h3 id="copy-process" tabindex="-1"><a class="header-anchor" href="#copy-process" aria-hidden="true">#</a> copy_process</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">copy_process</span><span class="token punctuation">(</span><span class="token keyword">int</span> nr<span class="token punctuation">,</span><span class="token keyword">long</span> ebp<span class="token punctuation">,</span><span class="token keyword">long</span> edi<span class="token punctuation">,</span><span class="token keyword">long</span> esi<span class="token punctuation">,</span><span class="token keyword">long</span> gs<span class="token punctuation">,</span><span class="token keyword">long</span> none<span class="token punctuation">,</span>
		<span class="token keyword">long</span> ebx<span class="token punctuation">,</span><span class="token keyword">long</span> ecx<span class="token punctuation">,</span><span class="token keyword">long</span> edx<span class="token punctuation">,</span>
		<span class="token keyword">long</span> fs<span class="token punctuation">,</span><span class="token keyword">long</span> es<span class="token punctuation">,</span><span class="token keyword">long</span> ds<span class="token punctuation">,</span>
		<span class="token keyword">long</span> eip<span class="token punctuation">,</span><span class="token keyword">long</span> cs<span class="token punctuation">,</span><span class="token keyword">long</span> eflags<span class="token punctuation">,</span><span class="token keyword">long</span> esp<span class="token punctuation">,</span><span class="token keyword">long</span> ss<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该函数的作用是从old进程中复制出一个new进程。 该函数在system_call.s中的sys_fork函数中执行。</p><p>copy_process从INT 0x80中断触发system_call系统调用，进而调用sys_fork。此时内核栈的状态如下所示：</p><figure><img src="https://github.com/zgjsxx/static-img-repo/raw/main/blog/Linux/kernel/Linux-0.11/Linux-0.11-kernel/fork/system_call_stack.png" alt="内核栈的状态" tabindex="0" loading="lazy"><figcaption>内核栈的状态</figcaption></figure><p>这与copy_process的参数是一致的。</p><p>该函数首先在内存中分配了一个空闲页用于存储进程的PCB，即task_struct结构。并将该PCB放入了PCB的数组中。</p><p>最后将old进程的PCB内容先直接拷贝给new进程。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">get_free_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
task<span class="token punctuation">[</span>nr<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">;</span>	
<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token operator">*</span>current<span class="token punctuation">;</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面这段就是将继承来的PCB结构进行适当的修改，详细解释见注释。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_UNINTERRUPTIBLE<span class="token punctuation">;</span><span class="token comment">//设置进程状态为不可被中断</span>
p<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> last_pid<span class="token punctuation">;</span><span class="token comment">//last_pid为find_empty_process找到的没有被使用的pid值， 将其设置给新的进程</span>
p<span class="token operator">-&gt;</span>father <span class="token operator">=</span> current<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span><span class="token comment">//设置该进程的父进程</span>
p<span class="token operator">-&gt;</span>counter <span class="token operator">=</span> p<span class="token operator">-&gt;</span>priority<span class="token punctuation">;</span><span class="token comment">//设置该进程的时间片， 值等于其优先级的值。</span>
p<span class="token operator">-&gt;</span>alarm <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//alarm定时的时间</span>
p<span class="token operator">-&gt;</span>leader <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//是否是进程组的leader</span>
p<span class="token operator">-&gt;</span>utime <span class="token operator">=</span> p<span class="token operator">-&gt;</span>stime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//用户态运行时间和和核心态运行时间</span>
p<span class="token operator">-&gt;</span>cutime <span class="token operator">=</span> p<span class="token operator">-&gt;</span>cstime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//子进程用户态运行时间和核心态运行时间。</span>
p<span class="token operator">-&gt;</span>start_time <span class="token operator">=</span> jiffies<span class="token punctuation">;</span><span class="token comment">//进程的开始时间设置为系统的滴答数。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面一段是设置PCB中有关TSS寄存器的值。下面也通过注释进行详解。</p><p>首先设置了内核栈的栈 <img src="https://github.com/zgjsxx/static-img-repo/raw/main/blog/Linux/kernel/Linux-0.11/Linux-0.11-kernel/fork/kernel_stack.png" alt="内核栈示意图" loading="lazy"></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>back_link <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>esp0 <span class="token operator">=</span> PAGE_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">;</span><span class="token comment">//进程的内核栈栈顶指针</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ss0 <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span><span class="token comment">//内核栈的段选择符</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来是设置<code>tss</code>寄存器关于其他cpu寄存器的值。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>eip <span class="token operator">=</span> eip<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>eflags <span class="token operator">=</span> eflags<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>eax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ecx <span class="token operator">=</span> ecx<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>edx <span class="token operator">=</span> edx<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ebx <span class="token operator">=</span> ebx<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>esp <span class="token operator">=</span> esp<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ebp <span class="token operator">=</span> ebp<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>esi <span class="token operator">=</span> esi<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>edi <span class="token operator">=</span> edi<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>es <span class="token operator">=</span> es <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>     <span class="token comment">//段寄存器取16位</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>cs <span class="token operator">=</span> cs <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ss <span class="token operator">=</span> ss <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ds <span class="token operator">=</span> ds <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>fs <span class="token operator">=</span> fs <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>gs <span class="token operator">=</span> gs <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面这里，设置<code>tss</code>中<code>ldt</code>的值。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>ldt <span class="token operator">=</span> <span class="token function">_LDT</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tss<span class="token punctuation">.</span>trace_bitmap <span class="token operator">=</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>GDT表中每一项是8个字节，每个进程拥有一个TSS和LDT，因此每个进程占用字节是16字节， 因此序号为n的进程的LDT在GDT表中的偏移量就是<code>n*16 + 5*8</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_LDT</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> n<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>FIRST_LDT_ENTRY<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如对上述知识遗忘，可以通过下面这张图进行温故。</p><figure><img src="https://github.com/zgjsxx/static-img-repo/raw/main/blog/Linux/kernel/Linux-0.11/Linux-0.11-kernel/fork/LDT.png" alt="LDT.png" tabindex="0" loading="lazy"><figcaption>LDT.png</figcaption></figure><p>下面这里进程内存的拷贝， 实际上确定进行进程新的线性地址， 并进行页表的拷贝。详见本文中copy_mem的讲解。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_mem</span><span class="token punctuation">(</span>nr<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    task<span class="token punctuation">[</span>nr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">free_page</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面主要处理对进程打开的文件的引用计数增加1。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NR_OPEN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token operator">=</span>p<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        f<span class="token operator">-&gt;</span>f_count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">)</span>
    current<span class="token operator">-&gt;</span>pwd<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span>
    current<span class="token operator">-&gt;</span>root<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>executable<span class="token punctuation">)</span>
    current<span class="token operator">-&gt;</span>executable<span class="token operator">-&gt;</span>i_count<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里设置GDT表中<code>tss</code>和<code>ldt</code>描述符的内容。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">set_tss_desc</span><span class="token punctuation">(</span>gdt<span class="token operator">+</span><span class="token punctuation">(</span>nr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>FIRST_TSS_ENTRY<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>tss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set_ldt_desc</span><span class="token punctuation">(</span>gdt<span class="token operator">+</span><span class="token punctuation">(</span>nr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>FIRST_LDT_ENTRY<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ldt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span>	<span class="token comment">/* do this last, just in case */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="copy-mem" tabindex="-1"><a class="header-anchor" href="#copy-mem" aria-hidden="true">#</a> copy_mem</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">copy_mem</span><span class="token punctuation">(</span><span class="token keyword">int</span> nr<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span> p<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>该函数的作用是复制进程的页表。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>    code_limit<span class="token operator">=</span><span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据代码段选择符获取代码段的长度</span>
    data_limit<span class="token operator">=</span><span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据数据段选择符获取数据段的长度</span>
    old_code_base <span class="token operator">=</span> <span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取代码段的起始位置</span>
    old_data_base <span class="token operator">=</span> <span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取数据段的起始位置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_data_base <span class="token operator">!=</span> old_code_base<span class="token punctuation">)</span>  <span class="token comment">//两个段起始位置相等</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;We don&#39;t support separate I&amp;D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data_limit <span class="token operator">&lt;</span> code_limit<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Bad data_limit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//确立新进程的代码段地址， Linux-0.11的线性地址是按照64M划分的，所以进程号nr的线性地址的起始位置是nr* 0x4000000</span>
    new_data_base <span class="token operator">=</span> new_code_base <span class="token operator">=</span> nr <span class="token operator">*</span> <span class="token number">0x4000000</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>start_code <span class="token operator">=</span> new_code_base<span class="token punctuation">;</span>  <span class="token comment">// 设置该位置到PCB中</span>
    <span class="token function">set_base</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new_code_base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置代码段的地址</span>
    <span class="token function">set_base</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new_data_base<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置数据段的地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面这段代码是将数据段所属的页表的进行。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_page_tables</span><span class="token punctuation">(</span>old_data_base<span class="token punctuation">,</span>new_data_base<span class="token punctuation">,</span>data_limit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;free_page_tables: from copy_mem\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free_page_tables</span><span class="token punctuation">(</span>new_data_base<span class="token punctuation">,</span>data_limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>copy_page_tables在memory.c中定义。</p><h3 id="verify-area" tabindex="-1"><a class="header-anchor" href="#verify-area" aria-hidden="true">#</a> verify_area</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">verify_area</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> addr<span class="token punctuation">,</span><span class="token keyword">int</span> size<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>该函数用于在进程空间进行写操作时进行地址验证的函数。</p><p>addr是指在进程线性地址中相对于起始位置的偏移量， size指的是大小。</p><p>由于检测判断是以4K页为单位进行操作的，因此程序需要找出addr所在页的起始地址，如下图所示。</p><figure><img src="https://github.com/zgjsxx/static-img-repo/raw/main/blog/Linux/kernel/Linux-0.11/Linux-0.11-kernel/fork/verify_area.png" alt="verify_area" tabindex="0" loading="lazy"><figcaption>verify_area</figcaption></figure><p>下面这段代码就是去寻找addr所在的内存页的起始地址， 即start。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>

start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> addr<span class="token punctuation">;</span>
size <span class="token operator">+=</span> start <span class="token operator">&amp;</span> <span class="token number">0xfff</span><span class="token punctuation">;</span> <span class="token comment">//size 加上页内偏移</span>
start <span class="token operator">&amp;=</span> <span class="token number">0xfffff000</span><span class="token punctuation">;</span> <span class="token comment">//start为逻辑地址的以4K为划分的起始地址</span>
start <span class="token operator">+=</span> <span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前进程在线性地址中数据段的起始地址， 加起来就是该逻辑地址转化到了线性地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面进行写保护验证， 如果页面不可以写，则进行页面复制。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">while</span> <span class="token punctuation">(</span>size<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    size <span class="token operator">-=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token function">write_verify</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    start <span class="token operator">+=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>write_verify</code>函数详解可以参考memory.c文件的讲解。</p><h3 id="find-empty-process" tabindex="-1"><a class="header-anchor" href="#find-empty-process" aria-hidden="true">#</a> find_empty_process</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">find_empty_process</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>该函数的作用是在全局的task数组中找到一个空闲的项，并返回其下标。其在system_call.s中的sys_fork函数中被调用。</p><p>首先是寻找一个pid值:</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>repeat<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">++</span>last_pid<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> last_pid<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NR_TASKS <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>pid <span class="token operator">==</span> last_pid<span class="token punctuation">)</span> <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着是去task数组中寻找可用的位置</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NR_TASKS <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,57),o=[e];function c(l,i){return s(),a("div",null,o)}const r=n(t,[["render",c],["__file","Linux-0.11-kernel-fork.html.vue"]]);export{r as default};
